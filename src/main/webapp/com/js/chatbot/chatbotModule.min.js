Date.prototype.format=function(t){if(!this.valueOf())return" ";var e=["일요일","월요일","화요일","수요일","목요일","금요일","토요일"],s=this;return t.replace(/(yyyy|yy|MM|dd|E|hh|mm|ss|a\/p)/gi,function(t){switch(t){case"yyyy":return s.getFullYear();case"yy":return(s.getFullYear()%1e3).zf(2);case"MM":return(s.getMonth()+1).zf(2);case"dd":return s.getDate().zf(2);case"E":return e[s.getDay()];case"HH":return s.getHours().zf(2);case"hh":return((h=s.getHours()%12)?h:12).zf(2);case"mm":return s.getMinutes().zf(2);case"ss":return s.getSeconds().zf(2);case"a/p":return s.getHours()<12?"오전":"오후";default:return t}})},String.prototype.string=function(t){for(var e="",s=0;s++<t;)e+=this;return e},String.prototype.zf=function(t){return"0".string(t-this.length)+this},Number.prototype.zf=function(t){return this.toString().zf(t)};var ChatbotModule=function(){function t(){this.isOpen=!1,this._chatbot_id=null,this._incoming_msgDiv=null,this._outgoing_msgDiv=null,this._chat_btn_area=null,this._chat_btn=null,this.el={},this.el._sendMessage=null,this.el._chatbox=null,this.el._sendForm=null,this._submitUrl=null,this._reqListUrl=null,this._ansLogUrl=null,this._chatbot_send_url="https://h2bqlk7k1x.apigw.ntruss.com/message/chatbot/",this._secret="elVISldzcUZ5TVNIT1NWSmptdXNyQlNMeEljUlJuVXE=",this._defualtUserId="Anonymous",this._defualtUserIp="0.0.0.0"}var o={log_no:null,ans_content:null,ans_result:null,error_msg:null};t.prototype.init=function(t){this.el._sendMessage=t.sendMessage,this.el._chatbox=t.chatbox,this.el._sendForm=t.sendForm,this._submitUrl="/chatbt/data/send.do",this._reqListUrl="/chatbt/data/req_list.do",this._ansLogUrl="/chatbt/data/ans_log.do",this.isOpen=!0,this._chatbot_id=this.guid(),this._incoming_msgDiv=$('<li class="in incoming_msg"><img class="avatar" alt="" src="/com/img/logo_chat_bot.png"><span class="name">관리자</span><div class="message"><span class="arrow"></span><span class="body received_msg"><p></p></span></div><span class="datetime time_date"></span></li>'),this._outgoing_msgDiv=$('<li class="out outgoing_msg"><img class="avatar" alt="" src="/com/img/avatar.png"><span class="name">사용자</span><div class="message"><span class="arrow"></span><span class="body sent_msg"><p></p></span></div><span class="datetime time_date"></span></li>'),this._chat_btn_area=$('<div class="form-list chat_btn_area"></div>'),this._chat_btn=$('<div class="chat_btn"><button class="t-left" type="button"></button></div>'),t.user_id&&this._outgoing_msgDiv.find(".name").text(t.user_id),this._user_id=t.user_id,this._user_ip=t._user_ip,this._crypto_function=t.crypto_function,this._encode_function=t.encode_function,this._encode_context=t.encode_context,this.bindEvent()},t.prototype.close=function(){this.isOpen=!1,this._chatbot_id=null},t.prototype.guid=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},t.prototype.bindEvent=function(){var e=this;$(this.el._chatbox).append(this.incomingMsg("안녕하세요. 환영합니다.")),$(this.el._sendMessage).on("keydown",function(t){13==t.keyCode&&e.sendChatbot()}),$(this.el._sendMessage).closest(".chat-form").find(".btn-cont .btn").on("click",function(){e.sendChatbot()})},t.prototype.sendChatbot=function(){var t=$(this.el._sendMessage),o=$(this.el._chatbox);o.append(this.outgoingMsg(t.val()));var e=$("<form></form>");e.hide(),e.append(t.clone(!0)),e.append('<input type="hidden" name="chatbot_id" value="'+this._chatbot_id+'" />');var s=this.makeSendObject(t.val()),n=JSON.stringify(s),a=this._crypto_function(n,this._secret),i=this._encode_function.call(this._encode_context,a),r=this;e.ajaxForm({url:this._submitUrl,dataType:"json",success:function(t){c.call(r,t)}}),e.appendTo("body"),e.submit(),e.remove(),t.val("");var c=function(t){var e=t.log_no;$.ajax({url:this._chatbot_send_url,contentType:"application/json; charset=utf-8",dataType:"json",type:"post",data:n,crossOrigin:!0,beforeSend:function(t){t.setRequestHeader("X-NCP-CHATBOT_SIGNATURE",i)},success:function(t){l.call(r,t,e)},error:function(t){console.log(t)}})},l=function(t,e){e=e;var s,n=t.bubbles[0];switch(t.log_no=e,n.type){case v.text:var a=n.data.description;s=r.incomingMsg(a),r.ansLogResp(t);break;case v.template:var i=n.data;s=r.incomingList(i),r.ansLogResp(t,s)}$(s).appendTo(o),QuickSidebar.init(),o.closest(".scroller").slimScroll({scrollTo:o[0].scrollHeight,alwaysVisible:!0})}},t.prototype.outgoingMsg=function(t){var e=this._outgoing_msgDiv.clone(!0);return e.find(".sent_msg p").html(this.replaceMsg(t)),e.find(".time_date").text(this.nowChatTime()),e},t.prototype.replaceMsg=function(t){for(var e=t.split("\n"),s=0,n=e.length,a="";s<n;s++){a+=e[s],s!==n-1&&(a+="<br>")}return a},t.prototype.nowChatTime=function(){return(new Date).format("a/p hh시 mm분")};var v={image:"image",text:"text",template:"template",button:"button",basic:"basic",postback:"postback",link:"link"};t.prototype.incomingList=function(t){var e=this,s=this._incoming_msgDiv.clone(!0),n=this._chat_btn_area.clone(!0),a=s.find(".received_msg p"),i=t.cover,o=t.contentTable,r=$(this._chat_btn_area).clone(!0);switch(i.type){case v.image:var c=i.data.description;a.html(this.replaceMsg(c)),s.find(".time_date").text(this.nowChatTime()),a.before("<div class='chat_image_area'><div class='image_align_center'><img src='"+i.data.imageUrl+"'></div></div>");break;case v.text:c=i.data.description;a.html(this.replaceMsg(c)),s.find(".time_date").text(this.nowChatTime())}for(var l=0,h=o.length;l<h;l++)for(var u=o[l],d=0,p=u.length;d<p;d++){var _=u[d].data;switch(_.type){case v.button:var g=(r=$(this._chat_btn).clone(!0)).find("button"),m=_.title;g.text(m);var b=_.data;switch(b.type){case v.basic:var f=b.action;switch(f.type){case v.postback:g.attr("postback",f.data.postback),g.on("click",function(){e.sendChatbtn(this)});break;case v.link:g.on("click",function(){window.open(f.data.url,"_blank")})}}n.append(r)}}return a.after(n),s},t.prototype.sendChatbtn=function(t){var a=this,e=$(this.el._sendMessage),s=$(t),i=$(this.el._chatbox);i.append(this.outgoingMsg(s.text()));var n=$("<form></form>");n.hide(),n.append(e.clone(!0).val(s.attr("postback"))),n.ajaxForm({url:this._submitUrl,dataType:"json",success:function(t){var e;switch(t.bubbles[0].type){case v.text:var s=t.bubbles[0].data.description;e=a.incomingMsg(s);break;case v.template:var n=t.bubbles[0].data;e=a.incomingList(n)}$(e).appendTo(i),QuickSidebar.init(),i.closest(".scroller").slimScroll({scrollTo:i[0].scrollHeight,alwaysVisible:!0})}}),n.appendTo("body"),n.submit(),n.remove()},t.prototype.incomingMsg=function(t){var e=this._incoming_msgDiv.clone(!0);return e.find(".received_msg p").html(this.replaceMsg(t)),e.find(".time_date").text(this.nowChatTime()),e},t.prototype.getReqJson=function(t,e){$.ajax({url:this._reqListUrl,data:{req_no:t},dataType:"json",async:!1}).done(function(t){"function"==typeof e&&e(t)})};var r="success";return t.prototype.ansLogResp=function(t,e){var s={};$.extend(!0,s,o);var n=t.log_no,a=t.bubbles[0],i=r;s.log_no=n,t.code?(i=t.code,s.error_msg=t.message):s.ans_content=e?e.html():a.data.description,s.ans_result=i,$.ajax({url:this._ansLogUrl,data:s,dataType:"json",async:!1}).done(function(t){})},t.prototype.makeSendObject=function(t){var e={},s={},n={},a=[];e.event="send";var i;i=i||"text";var o=this._user_id?this._defualtUserId:o,r=this._user_ip?this._defualtUserIp:r;return e.version="v2",e.userId=o,e.userIp=r,e.timestamp=(new Date).getTime(),s.type=i,n.description=t,s.data=n,a.push(s),e.bubbles=a,e},t}(),chatbotModule=new ChatbotModule;